#!/usr/bin/env ruby

unless ARGV.any?
  warn(
    <<-DOC
    Usage: #{$PROGRAM_NAME} [environment-name]

    Runs all available scenarios against the specified environment. Requires the specified environment config script to exist inside the  artillery/environments folder.

    Required Environment Variables:
      ACCESS_TOKEN - A valid GitLab Personal Access Token for the specified environment. The token should come from a User that has admin access for the project(s) to be tested and have API and read_repository permissions.

    Optional Environment Variables:
      ARTILLERY_VERBOSE - Shows all output from Artillery. Warning: This output is very verbose. Default: false.
      QUARANTINED - Will include any tests inside the artillery/scenarios/quarantined folder when true. Default: false.

    Example(s):
      #{$PROGRAM_NAME} onprem.testbed.gitlab.net
    DOC
  )
  exit 1
end

aggregated_success = true

def run_environment(name)
  script_path = File.dirname(__FILE__)

  cmd = [
    File.join(script_path, "run-scenarios"),
    File.join(script_path, "environments", name + ".yml"),
    "--",
    Dir[File.join(script_path, "scenarios", "*.yml")],
    Dir[File.join(script_path, "scenarios", name, "*.yml")],
    ENV['QUARANTINED'] ? Dir[File.join(script_path, "scenarios", "quarantined", "*.yml")] : nil
  ].flatten.compact

  warn("$ #{cmd.join(' ')}")
  system(*cmd)
end

ARGV.each do |environment_name|
  result = run_environment(environment_name)
  aggregated_success = false unless result
end

exit(1) unless aggregated_success
