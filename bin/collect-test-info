#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../lib', __dir__)

require 'collect_test_info'
require 'fileutils'
require 'open3'
require 'table_print'
require 'time'

# Get parent folder(`k6`) path from the current file
k6_dir = File.expand_path('../k6', __dir__)

current_time = Time.now
results_dir = File.join("#{k6_dir}/results", "tests_wiki_#{current_time.strftime('%Y%m%d_%H%M%S')}")
puts "\nCollecting all test info and saving to #{results_dir}"
FileUtils.mkdir_p(results_dir)

tests = RunK6.get_tests(test_paths: ["#{k6_dir}/tests"], quarantined: true, scenarios: true, custom: true)

aggregated_tests = []
tests.each do |test|
  aggregated_tests << TestInfo.parse_test_docs_for_info(test)
end
test_types = aggregated_tests.map { |test| test[:type] }.uniq
aggregated_tests_doc_txt = File.join(results_dir, "aggregated_tests_doc.txt")
docs_summary = <<~DOC
  GitLab Performance Tool consists of different types of tests:
  * `api` - API endpoint tests
  * `git` - git-related tests
  * `scenarios` - standalone test scenarios
  * `web` - Web page tests
  * `quarantined` - tests that are quarantined because of some ongoing issue with endpoint or test itself
DOC
tp.set(:max_width, 800)

File.open(aggregated_tests_doc_txt, 'w') do |file|
  file.write("#{docs_summary}\n")
  tp.set :io, file
  test_types.each do |type|
    file.write("\n## #{type.upcase}\n")
    aggregated_tests_by_type = aggregated_tests.select { |test| test[:type] == type }
    tp(aggregated_tests_by_type)
  end
  tp.clear :io
end
