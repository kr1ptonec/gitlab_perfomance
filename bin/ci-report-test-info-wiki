#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../lib', __dir__)

require 'test_info'
require 'gpt_common'
require 'optimist'
require 'run_k6'
require 'table_print'

# Get parent folder(`k6`) path from the current file
k6_dir = File.expand_path('../k6', __dir__)

@opts = Optimist.options do
  banner "Usage: ci-report-test-info-wiki [options]"
  banner "\nReports GitLab Performance Tool test details to a Wiki. Designed for us in GitLab CI."
  banner "\nOptions:"
  opt :help, 'Show help message'
  opt :page_title, "Title to use for wiki page", type: :string, required: true
  opt :api_url, "GitLab wiki API URL", type: :string, default: "https://gitlab.com/api/v4/projects/gitlab-org%2Fquality%2Fperformance/wikis"
  banner "\nEnvironment Variable(s):"
  banner "  CI_PROJECT_ACCESS_TOKEN   A valid GitLab Personal Access Token that has access to the intended project where the wiki page will be posted. The token should come from a User that has admin access for the project(s) and have API permissions. (Default: nil)"
end

raise 'Environment Variable CI_PROJECT_ACCESS_TOKEN must be set to proceed. See command help for more info' unless ENV['CI_PROJECT_ACCESS_TOKEN']

puts "Collecting test info..."
tests = RunK6.get_tests(k6_dir: k6_dir, test_paths: ["tests"], quarantined: true, scenarios: true, read_only: false)
aggregated_tests = []
tests.each do |test|
  aggregated_tests << TestInfo.parse_test_docs_for_info(test)
end
test_types = aggregated_tests.map { |test| test[:type] }.uniq

puts "Collecting known issues..."
aggregated_issues = TestInfo.get_known_issues(k6_dir)

wiki_report_contents = <<~DOC
  GitLab Performance Tool provides several different types of tests:
  * [`api`](#api) - API endpoint tests
  * [`git`](#git) - git-related tests
  * [`scenarios`](#scenarios) - standalone test scenarios
  * [`web`](#web) - Web page tests
  * [`quarantined`](#quarantined) - tests that are quarantined because of some ongoing issue with endpoint or test itself

  **Note:** Some endpoints have [known issues](#known-issues). These tests have either been run with a custom lower threshold limit applied or are quarantined until the issue is fixed.
DOC
tp.set(:max_width, 800)

test_types.each do |type|
  wiki_report_contents << "\n## #{type.match?(/api/) ? type.upcase : type.capitalize}\n"
  aggregated_tests_by_type = aggregated_tests.select { |test| test[:type] == type }
  wiki_report_contents << TablePrint::Printer.table_print(aggregated_tests_by_type)
end

wiki_report_contents << "\n## Known Issues\n"
wiki_report_contents << TablePrint::Printer.table_print(aggregated_issues)

puts "Posting test info to Wiki page..."
headers = {
  'Authorization': "Bearer #{ENV['CI_PROJECT_ACCESS_TOKEN']}"
}

create_params = {
  title: @opts[:page_title],
  content: "Autogenerated by GitLab Performance Tool"
}
GPTCommon.make_http_request(method: 'post', url: @opts[:api_url], params: create_params, headers: headers)

edit_params = {
  title: @opts[:page_title],
  content: wiki_report_contents
}
GPTCommon.make_http_request(method: 'put', url: "#{@opts[:api_url]}/#{@opts[:page_title]}", params: edit_params, headers: headers)
puts "Test info posted"
