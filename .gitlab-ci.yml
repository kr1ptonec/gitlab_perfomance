image: "starefossen/ruby-node:2-10-slim"

include:
  - local: '/includes/gitaly-n-plus-one-tests.yml'

stages:
  - test
  - test-quarantine
  - notification

.base-artillery: &base-artillery
  stage: test
  script:
    - yarn global add artillery@1.6.0-27
    - scripts/$ARTILLERY_SCRIPT_FILE
  only:
    refs:
      - schedules
    variables:
      - $TEST_TYPE == "Load Tests"

##########################
## Artillery Load Tests ##
##########################

artillery-api-single-scenario:
  before_script:
    - export "ARTILLERY_SCRIPT_FILE=artillery-api-single-scenario"
  <<: *base-artillery

################################
## SiteSpeed Performance Test ##
################################

sitespeed-performance:
  stage: test
  image: docker:git
  services:
    - docker:stable-dind
  script:
    - mkdir sitespeed-results
    - docker run --shm-size=1g --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io:6.3.1 --outputFolder sitespeed-results --slack.hookUrl $SLACK_HOOK_URL --slack.type summary $URL_FILE
  only:
    refs:
      - schedules
    variables:
      - $TEST_TYPE == "SiteSpeed Tests"
  artifacts:
    paths:
      - sitespeed-results/

######################
# Notification jobs ##
######################
.notify: &notify
  image: alpine
  stage: notification
  dependencies: []
  cache: {}
  before_script:
    - apk update && apk add git curl bash
  only:
    - schedules

notify-slack-success:
  <<: *notify
  script:
    - bin/slack qa-performance "🎉 $TEST_TYPE against $TARGET_ENVIRONMENT passed! 🎉 See $CI_PIPELINE_URL." ci_passing
  when: on_success

notify-slack-fail:
  <<: *notify
  script:
    - bin/slack qa-performance "☠️ $TEST_TYPE against $TARGET_ENVIRONMENT failed! ☠️ See $CI_PIPELINE_URL." ci_failing
  when: on_failure
