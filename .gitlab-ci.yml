include:
  - local: '.gitlab/ci/gpt-lint.yml'
  - local: '.gitlab/ci/.gpt-k6-base.yml'
  - local: '.gitlab/ci/gpt-k6.yml'
  - local: '.gitlab/ci/gpt-k6-compare.yml'
  - local: '.gitlab/ci/gpt-docker.yml'
  - local: '.gitlab/ci/gpt-data-generator.yml'
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml

#################################
##      Security Scanning      ##
#################################

.on_merge_request_and_merged_events:
  rules:
    - if: '$CI_BUILD_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'

gemnasium-dependency_scanning:
  stage: check
  rules:
    - !reference [.on_merge_request_and_merged_events, rules]

container_scanning:
  stage: check
  variables:
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE/gitlab-performance-tool:latest
    DOCKERFILE_PATH: Dockerfile.gpt
  rules:
    - !reference [.on_merge_request_and_merged_events, rules]

container_scanning 2/2:
  extends: container_scanning
  variables:
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE/gpt-data-generator:latest
    DOCKERFILE_PATH: Dockerfile.gpt-data-generator
