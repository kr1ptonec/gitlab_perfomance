#######################
##     MR Checks     ##
#######################
check:sitespeed:
  stage: check
  image: docker:git
  services:
    - docker:stable-dind
  script:
    - docker pull sitespeedio/sitespeed.io
    - docker run --shm-size=1g --rm sitespeedio/sitespeed.io https://staging.gitlab.com -n 1
  except:
    - schedules

#################################
## SiteSpeed Performance Tests ##
#################################
sitespeed-performance:
  stage: test
  image: docker:git
  services:
    - docker:stable-dind
  tags:
    - docker
  script:
    - docker pull sitespeedio/sitespeed.io
    - docker run --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io --config sitespeed/config.json --slack.hookUrl $CI_SLACK_WEBHOOK_URL $URL_FILE
  only:
    refs:
      - schedules
    variables:
      - $TEST_TYPE == "SiteSpeed"
  artifacts:
    when: always
    paths:
      - sitespeed/results/
    expire_in: 14d

#######################
##    Report Jobs    ##
#######################
.report:
  image: alpine
  stage: report
  before_script:
    - apk add curl
  only:
    - schedules
  except:
    variables:
      - $CI_SLACK_REPORT != "true"
      - $CI_SLACK_WEBHOOK_URL == null
      - $CI_SLACK_CHANNEL == null

report-slack-sitespeed:
  extends: .report
  script:
    - bin/slack "$TEST_TYPE against $TARGET_ENVIRONMENT has finished!\nPipeline - $CI_PIPELINE_URL" ci_passing
  only:
    variables:
      - $TEST_TYPE =~ /^SiteSpeed.*/
