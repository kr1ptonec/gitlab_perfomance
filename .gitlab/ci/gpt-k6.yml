# Depends: .gpt-k6-base.yml

#####################
##  Commit Checks  ##
#####################
check:k6:
  stage: check
  extends: .k6-base
  script:
    - ACCESS_TOKEN=$GPT_CHECK_STAGING_ACCESS_TOKEN bin/run-k6 -e staging.json -t api_v4_projects_project.js api_v4_groups_group.js
  only:
    - master
    - merge_requests
  except:
    - schedules
    - tags

check:generator:
  stage: check
  extends: .k6-base
  services:
    - docker:stable-dind
  tags:
    - performance
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker:2375
    ROOT_GROUP: generator_test
    GPT_CP_DOCKER_IMAGE: registry.gitlab.com/gitlab-org/quality/performance-images/gitlab-ce-performance
    MAJOR_VERSION: 13
    MINOR_VERSION: 0
  script:
    - apk add docker
    - echo "$GPT_CP_DOCKER_IMAGE:$MAJOR_VERSION.$MINOR_VERSION.0-ce.0"
    - bin/run-gitlab-docker --image $GPT_CP_DOCKER_IMAGE:$MAJOR_VERSION.$MINOR_VERSION.0-ce.0
    - sleep 60s
    - ACCESS_TOKEN=$ACCESS_TOKEN bin/generate-gpt-data -e $ENVIRONMENT_NAME.json --unattended --large-project-tarball $LARGE_PROJECT_TARBALL --root-group $ROOT_GROUP -s 5 -p 5
    # Check that the Generator is idempotent
    - ACCESS_TOKEN=$ACCESS_TOKEN bin/generate-gpt-data -e $ENVIRONMENT_NAME.json --unattended --large-project-tarball $LARGE_PROJECT_TARBALL --root-group $ROOT_GROUP -s 5 -p 5
    - ACCESS_TOKEN=$ACCESS_TOKEN bin/generate-gpt-data -e $ENVIRONMENT_NAME.json --unattended --clean-up --root-group $ROOT_GROUP
  only:
    variables:
      - $GPT_DATA_GENERATOR

########################
##  Environment Jobs  ##
########################
update-environment:
  stage: build
  variables:
    ENVIRONMENT_NAME: $ENVIRONMENT_NAME
    ENVIRONMENT_ACTION: update
    GCP_PROJECT_NAME: $GCP_PROJECT_NAME
    GCP_GITLAB_NODE_PREFIX: $GCP_GITLAB_NODE_PREFIX
  trigger:
    project: gitlab-org/quality/performance-environment-builder
    branch: $ENVIRONMENT_BUILDER_BRANCH
    strategy: depend
  only:
    variables:
      - $ENVIRONMENT_UPDATE == "true"

stop-environment:
  stage: stop
  variables:
    ENVIRONMENT_NAME: $ENVIRONMENT_NAME
    ENVIRONMENT_ACTION: stop
    GCP_PROJECT_NAME: $GCP_PROJECT_NAME
    GCP_GITLAB_NODE_PREFIX: $GCP_GITLAB_NODE_PREFIX
  trigger:
    project: gitlab-org/quality/performance-environment-builder
    branch: $ENVIRONMENT_BUILDER_BRANCH
    strategy: depend
  only:
    variables:
      - $ENVIRONMENT_STOP == "true"
  when: always

#####################################
##   k6 Load Tests - Environments  ##
#####################################
k6:
  stage: test
  extends: .k6-base
  script:
    - bin/run-k6 -s -e $ENVIRONMENT_NAME.json -o $OPTIONS_FILE.json -u $([ -n "$QUARANTINED" ] && echo "-q")
  only:
    refs:
      - schedules
    variables:
      - $TEST_TYPE == "k6"
  except:
    variables:
      - $ENVIRONMENT_NAME == null
  tags:
    - performance
  artifacts:
    when: always
    paths:
      - results/
    expire_in: 14d
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

###############################
##    Report Jobs - Slack    ##
###############################
report-k6-success-slack:
  extends: .report-k6-slack-base
  variables:
    TEST_RESULT: "passed"
  only:
    variables:
      - $TEST_TYPE == "k6"
  when: on_success

report-k6-failure-slack:
  extends: .report-k6-slack-base
  variables:
    TEST_RESULT: "failed"
  only:
    variables:
      - $TEST_TYPE == "k6"
  when: on_failure

##############################
##    Report Jobs - Wiki    ##
##############################
report-k6-results-wiki:
  extends: .report-k6-wiki-base
  variables:
    WIKI_PAGE: "Benchmarks/Latest/$ENVIRONMENT_NAME"
  only:
    variables:
      - $TEST_TYPE == "k6"

report-k6-test-info-wiki:
  extends: .report-k6-wiki-base
  script:
    - bin/ci-report-test-info-wiki -p "Current Test Details"
  only:
    - tags
